name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: [self-hosted, macOS, ARM64, claudl]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build universal binary
        run: |
          swift build -c release --arch arm64
          swift build -c release --arch x86_64
          mkdir -p dist
          lipo -create \
            .build/arm64-apple-macosx/release/macrack \
            .build/x86_64-apple-macosx/release/macrack \
            -output dist/macrack

      - name: Code sign
        env:
          DEVELOPER_ID_APPLICATION: ${{ secrets.DEVELOPER_ID_APPLICATION }}
        run: |
          codesign --force --options runtime \
            --sign "$DEVELOPER_ID_APPLICATION" \
            dist/macrack

      - name: Notarize
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          # Create API key file
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8

          # Create zip for notarization
          ditto -c -k dist/macrack dist/macrack.zip

          # Submit and wait
          xcrun notarytool submit dist/macrack.zip \
            --key ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8 \
            --key-id "$APP_STORE_CONNECT_KEY_ID" \
            --issuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --wait

      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${GITHUB_REF_NAME}" \
            --title "${GITHUB_REF_NAME}" \
            --generate-notes \
            dist/macrack
